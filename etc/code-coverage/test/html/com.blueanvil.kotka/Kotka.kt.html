<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Kotka.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">kotka</a> &gt; <a href="index.source.html" class="el_package">com.blueanvil.kotka</a> &gt; <span class="el_source">Kotka.kt</span></div><h1>Kotka.kt</h1><pre class="source lang-java linenums">package com.blueanvil.kotka

import org.apache.kafka.clients.admin.AdminClient
import org.apache.kafka.clients.admin.NewTopic
import org.slf4j.LoggerFactory
import java.time.Duration
import java.util.*
import kotlin.reflect.KClass
import kotlin.reflect.full.findAnnotation

/**
 * @author Cosmin Marginean
 */
<span class="fc" id="L14">class Kotka(private val kafkaServers: String,</span>
            private val replicationFactor: Short,
            private val partitionCount: Int = 256,
            private val consumerProps: Properties? = null,
            producerProps: Properties? = null,
            private val pollTimeout: Duration = Duration.ofMillis(500),
            messageSerializer: (Any) -&gt; String = ToJson()) {

<span class="fc" id="L22">    private val producer = Producer(kafkaServers, messageSerializer, producerProps)</span>

    fun &lt;T : Any&gt; send(message: T) {
<span class="fc" id="L25">        val annotation = message::class.findAnnotation&lt;KotkaMessage&gt;()</span>
<span class="fc" id="L26">                ?: throw IllegalArgumentException(&quot;Message class $message::class is not annotated with ${KotkaMessage::class}&quot;)</span>
<span class="fc" id="L27">        producer.send(annotation.topic, message)</span>
<span class="fc" id="L28">    }</span>

    fun &lt;T : Any&gt; send(topic: String, message: T) {
<span class="fc" id="L31">        producer.send(topic, message)</span>
<span class="fc" id="L32">    }</span>

    fun &lt;T : Any&gt; consumer(messageClass: KClass&lt;T&gt;,
                           messageHandler: (T) -&gt; Unit) {
<span class="fc" id="L36">        val annotation = messageClass.findAnnotation&lt;KotkaMessage&gt;()</span>
<span class="fc" id="L37">                ?: throw IllegalArgumentException(&quot;Message class $messageClass is not annotated with ${KotkaMessage::class}&quot;)</span>
<span class="fc" id="L38">        consumer(annotation.topic, annotation.threads, messageClass, annotation.pubSub, messageHandler)</span>
<span class="fc" id="L39">    }</span>

    fun &lt;T : Any&gt; consumer(topic: String,
                           threads: Int,
                           messageClass: KClass&lt;T&gt;,
                           pubSub: Boolean = false,
                           messageHandler: (T) -&gt; Unit) {
<span class="fc" id="L46">        createTopic(topic)</span>
<span class="fc" id="L47">        Consumer(kafkaServers = kafkaServers,</span>
<span class="fc" id="L48">                topic = topic,</span>
<span class="fc" id="L49">                threads = threads,</span>
<span class="fc" id="L50">                messageClass = messageClass,</span>
<span class="fc" id="L51">                consumerProps = consumerProps,</span>
<span class="fc" id="L52">                messageDeserialiser = FromJson(messageClass),</span>
<span class="fc" id="L53">                pubSub = pubSub,</span>
<span class="fc" id="L54">                pollTimeout = pollTimeout).run(messageHandler)</span>
<span class="fc" id="L55">    }</span>

    fun createTopic(topic: String) {
<span class="fc" id="L58">        val properties = Properties()</span>
<span class="fc" id="L59">        properties.setProperty(&quot;bootstrap.servers&quot;, kafkaServers)</span>
<span class="fc" id="L60">        val client = AdminClient.create(properties)</span>

<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        if (client.listTopics().names().get().contains(topic)) {</span>
<span class="nc" id="L63">            log.info(&quot;Topic $topic already exists. Skipping&quot;)</span>
        } else {
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">            client.createTopics(listOf(NewTopic(topic, partitionCount, replicationFactor))).values()[topic]!!.get()</span>
<span class="fc" id="L66">            wait(10, 500, &quot;Topic $topic was not created&quot;) { client.listTopics().names().get().contains(topic) }</span>
<span class="fc" id="L67">            log.info(&quot;Created topic $topic&quot;)</span>
        }
<span class="fc" id="L69">    }</span>

    companion object {
<span class="fc" id="L72">        private val log = LoggerFactory.getLogger(Kotka::class.java)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>